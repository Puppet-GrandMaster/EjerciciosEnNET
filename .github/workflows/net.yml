name: Build NET Framework/Core

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET Core 3.1 (Migrating soon)
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.302

    - name: Setup .NET 5
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.100

    - name: Restore packages for main solution
      run: dotnet restore

    - name: Restore packages for AdventOfCode2020
      run: dotnet restore AdventOfCode2020/AdventOfCode2020.sln

    - name: Install Framework dependencies
      run: nuget restore ABM\ABM.sln
      
    - name: Install Coverlet
      run: dotnet tool install --global coverlet.console

    - name: Install Codecov
      run: dotnet tool install --global Codecov.Tool

    - name: Setup VSTest.console.exe
      uses: darenm/Setup-VSTest@v1

    - name: Build Main Solution in Debug
      run: dotnet build --configuration Debug --no-restore
      
    - name: Build AdventOfCode Solution in Debug
      run: dotnet build --configuration Debug --no-restore AdventOfCode2020\AdventOfCode2020.sln

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Build Debug
      run: msbuild ABM\ABM.sln

    - name: Testing Palindromo
      run: coverlet Palindromo/Palindromo.UnitTests/bin/Debug/netcoreapp3.0/Palindromo.UnitTests.dll --target "dotnet" --targetargs "test Palindromo/Palindromo.UnitTests/Palindromo.UnitTests.csproj --no-build --verbosity quiet" --format OpenCover --output palindromo.coverage.xml

    - name: Testing Anaconda
      run: coverlet Anaconda/Anaconda.UnitTests/bin/Debug/netcoreapp3.0/Anaconda.UnitTests.dll --target "dotnet" --targetargs "test Anaconda/Anaconda.UnitTests/Anaconda.UnitTests.csproj --no-build --verbosity quiet" --format OpenCover --output anaconda.coverage.xml

    - name: Testing ABM
      run: coverlet ABM\ABM.Core.UnitTests\bin\Debug\ABM.Core.UnitTests.dll --target "vstest.console.exe" --targetargs "ABM\ABM.Core.UnitTests\bin\Debug\ABM.Core.UnitTests.dll" --format OpenCover --output abm.coverage.xml --exclude-by-file "**/My Project/*"

    - name: Testing AdventOfCode2020.Day1
      run: coverlet AdventOfCode2020/Day1/Day1.UnitTests/bin/Debug/net5.0/Day1.UnitTests.dll --target "dotnet" --targetargs "test AdventOfCode2020/Day1/Day1.UnitTests/bin/Debug/net5.0/Day1.UnitTests.dll --no-build" --format OpenCover --output adventofcode2020day1.coverage.xml

    - name: Testing AdventOfCode2020.Day2
      run: coverlet AdventOfCode2020/Day2/Day2.UnitTests/bin/Debug/net5.0/Day2.UnitTests.dll --target "dotnet" --targetargs "test AdventOfCode2020/Day2/Day2.UnitTests/bin/Debug/net5.0/Day2.UnitTests.dll --no-build" --format OpenCover --output adventofcode2020day2.coverage.xml

    - name: Upload
      run: codecov -f *.coverage.xml -t ${{ secrets.CODECOV_TOKEN }}
